# å®å®æ™ºèƒ½é—¨é“ƒ - Home Assistant é›†æˆ

åŸºäºé€†å‘çš„Pythonæ¨é€å®ç°çš„Home Assistantè‡ªå®šä¹‰é›†æˆï¼Œæ”¯æŒå®å®æ™ºèƒ½é—¨é“ƒ/æ‘„åƒå¤´çš„å¼€é—¨äº‹ä»¶ç›‘æ§ã€è¿œç¨‹å¼€é”ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… å®æ—¶æ¨é€ç›‘å¬ï¼ˆåŸºäºSSL/TLSï¼‰
- âœ… å¼€é—¨äº‹ä»¶ç›‘æ§ï¼ˆæŒ‡çº¹ã€å¯†ç ã€é—¨å†…å¼€é”ï¼‰
- âœ… é—¨é“ƒå‘¼å«é€šçŸ¥
- âœ… è®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€
- âœ… å¤šç§æŠ¥è­¦äº‹ä»¶ï¼ˆPIRç§»åŠ¨ä¾¦æµ‹ã€ä½ç”µé‡ã€æ¸©åº¦æŠ¥è­¦ç­‰ï¼‰
- âœ… é—¨é”çŠ¶æ€ä¼ æ„Ÿå™¨ï¼ˆè‡ªåŠ¨5ç§’æ¢å¤ï¼‰
- âœ… å®Œå…¨è„±ç¦»Androidç³»ç»Ÿè¿è¡Œ
- âœ… TokenæŒä¹…åŒ–å­˜å‚¨
- âœ… çº¿ç¨‹å®‰å…¨çš„äº‹ä»¶å¤„ç†

## GitHubä»“åº“

ğŸ“¦ **GitHubåœ°å€**: https://github.com/thedays/ha-dingding-smart

## å®‰è£…

### æ–¹æ³•1ï¼šé€šè¿‡HACSå®‰è£…ï¼ˆæ¨èï¼‰

1. æ‰“å¼€Home Assistant
2. è¿›å…¥ "HACS" â†’ "é›†æˆ"
3. ç‚¹å‡» "æµè§ˆå¹¶ä¸‹è½½é›†æˆ"
4. æœç´¢ "dingding" æˆ– "å®å®æ™ºèƒ½"
5. ç‚¹å‡»å®‰è£…
6. é‡å¯Home Assistant

### æ–¹æ³•2ï¼šæ‰‹åŠ¨å®‰è£…

å°† `custom_components/dingding_smart` ç›®å½•å¤åˆ¶åˆ°ä½ çš„Home Assistanté…ç½®ç›®å½•ï¼š

```bash
# é»˜è®¤é…ç½®ç›®å½•
cp -r custom_components/dingding_smart ~/.homeassistant/custom_components/

# å¯¹äºDockerå®‰è£…
cp -r custom_components/dingding_smart /path/to/your/homeassistant/config/custom_components/

# å¯¹äºHome Assistant OS
# é€šè¿‡Sambaæˆ–SSHå¤åˆ¶åˆ°/config/custom_components/ç›®å½•
```

### 3. é‡å¯Home Assistant

```bash
# å¦‚æœä½¿ç”¨Docker
docker restart homeassistant

# å¦‚æœä½¿ç”¨Home Assistant OS
# åœ¨ç•Œé¢ä¸­ç‚¹å‡» "è®¾ç½®" -> "ç³»ç»Ÿ" -> "é‡å¯"
```

### 4. æ·»åŠ é›†æˆ

1. æ‰“å¼€Home Assistant
2. è¿›å…¥ "è®¾ç½®" â†’ "è®¾å¤‡ä¸æœåŠ¡"
3. ç‚¹å‡» "æ·»åŠ é›†æˆ"
4. æœç´¢ "dingding" æˆ– "å®å®æ™ºèƒ½"
5. å¡«å†™é…ç½®ä¿¡æ¯ï¼š
   - ç”¨æˆ·åï¼šå®å®æ™ºèƒ½Appçš„ç™»å½•è´¦å·ï¼ˆæ‰‹æœºå·ï¼‰
   - å¯†ç ï¼šå®å®æ™ºèƒ½Appçš„ç™»å½•å¯†ç 
   - æœåŠ¡å™¨åŒºåŸŸï¼šé€‰æ‹©æœåŠ¡å™¨æ‰€åœ¨åŒºåŸŸï¼ˆä¸­å›½/æ¬§æ´²/ç¾å›½ï¼‰
6. ç‚¹å‡» "æäº¤"

## é…ç½®

### åŸºæœ¬é…ç½®

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| ç”¨æˆ·å | å®å®æ™ºèƒ½Appçš„ç™»å½•è´¦å· | `13800138000` |
| å¯†ç  | å®å®æ™ºèƒ½Appçš„ç™»å½•å¯†ç  | `your_password` |
| æœåŠ¡å™¨åŒºåŸŸ | é€‰æ‹©æœåŠ¡å™¨æ‰€åœ¨åŒºåŸŸ | `ä¸­å›½` / `æ¬§æ´²` / `ç¾å›½` |

### å¯é€‰é…ç½®

åœ¨ `configuration.yaml` ä¸­æ·»åŠ ä»¥ä¸‹å¯é€‰é…ç½®ï¼š

```yaml
dingding_smart:
  username: 13800138000
  password: your_password
  server_region: cn  # cn, eu, us
  device_uid: "your_device_uid"  # å¯é€‰ï¼šåªç›‘å¬æŒ‡å®šè®¾å¤‡
  user_id: 12742576  # å¯é€‰ï¼šç”¨æˆ·ID
  imei: "your_imei"  # å¯é€‰ï¼šè®¾å¤‡IMEIå·ï¼Œç”¨äºæ¨é€ç»‘å®š
```

## å®ä½“

### ä¼ æ„Ÿå™¨å®ä½“

é›†æˆä¼šä¸ºæ¯ä¸ªè®¾å¤‡åˆ›å»ºä»¥ä¸‹ä¼ æ„Ÿå™¨ï¼š

| å®ä½“ID | åç§° | è¯´æ˜ |
|---------|------|------|
| `sensor.{device_name}_battery` | ç”µæ± ç”µé‡ | è®¾å¤‡ç”µæ± ç”µé‡ç™¾åˆ†æ¯” |
| `sensor.{device_name}_wifi_signal` | WiFiä¿¡å· | è®¾å¤‡WiFiä¿¡å·å¼ºåº¦ |
| `sensor.{device_name}_status` | è®¾å¤‡çŠ¶æ€ | è®¾å¤‡å½“å‰çŠ¶æ€ |
| `sensor.{device_name}_last_unlock` | æœ€åå¼€é” | æœ€åä¸€æ¬¡å¼€é”äº‹ä»¶ä¿¡æ¯ |
| `binary_sensor.{device_name}_door_lock` | é—¨é”çŠ¶æ€ | é—¨é”å¼€å…³çŠ¶æ€ï¼ˆ5ç§’è‡ªåŠ¨æ¢å¤ï¼‰ |

### é—¨é”çŠ¶æ€ä¼ æ„Ÿå™¨

é—¨é”çŠ¶æ€ä¼ æ„Ÿå™¨ä¼šåœ¨æ£€æµ‹åˆ°å¼€é”äº‹ä»¶æ—¶è‡ªåŠ¨å˜ä¸º"å¼€é”"çŠ¶æ€ï¼Œ5ç§’åè‡ªåŠ¨æ¢å¤ä¸º"å…³é”"çŠ¶æ€ã€‚

**æ”¯æŒçš„å¼€é”æ–¹æ³•**ï¼š
- `fingerprint` - æŒ‡çº¹å¼€é”
- `password` - å¯†ç å¼€é”
- `inside_lock` - é—¨å†…å¼€é”

## äº‹ä»¶

é›†æˆä¼šè§¦å‘ä»¥ä¸‹Home Assistantäº‹ä»¶ï¼š

### å¼€é—¨äº‹ä»¶

**äº‹ä»¶å**: `dingding_smart_door_unlock`

**æ•°æ®**:
```json
{
  "uid": "device_uid",
  "method": "fingerprint|password|inside_lock",
  "message": "å¼€é—¨æ¶ˆæ¯",
  "alert": "æç¤ºä¿¡æ¯",
  "name": "è®¾å¤‡åç§°"
}
```

**å¼€é”æ–¹æ³•**:
- `fingerprint`: æŒ‡çº¹å¼€é”
- `password`: å¯†ç å¼€é”
- `inside_lock`: é—¨å†…å¼€é”

### é—¨é“ƒå‘¼å«äº‹ä»¶

**äº‹ä»¶å**: `dingding_smart_door_call`

**æ•°æ®**:
```json
{
  "uid": "device_uid",
  "message": "å‘¼å«æ¶ˆæ¯",
  "alert": "æç¤ºä¿¡æ¯",
  "name": "è®¾å¤‡åç§°"
}
```

### è®¾å¤‡ç¦»çº¿äº‹ä»¶

**äº‹ä»¶å**: `dingding_smart_door_offline`

**æ•°æ®**:
```json
{
  "uid": "device_uid",
  "message": "ç¦»çº¿æ¶ˆæ¯",
  "alert": "æç¤ºä¿¡æ¯",
  "name": "è®¾å¤‡åç§°"
}
```

### è®¾å¤‡ä¸Šçº¿äº‹ä»¶

**äº‹ä»¶å**: `dingding_smart_door_online`

**æ•°æ®**:
```json
{
  "uid": "device_uid",
  "message": "ä¸Šçº¿æ¶ˆæ¯",
  "alert": "æç¤ºä¿¡æ¯",
  "name": "è®¾å¤‡åç§°"
}
```

### æŠ¥è­¦äº‹ä»¶

**äº‹ä»¶å**: `dingding_smart_alarm`

**æ•°æ®**:
```json
{
  "uid": "device_uid",
  "type": "0|4|8|9|10",
  "message": "æŠ¥è­¦æ¶ˆæ¯",
  "alert": "æç¤ºä¿¡æ¯",
  "name": "è®¾å¤‡åç§°"
}
```

**æŠ¥è­¦ç±»å‹**:
- `0`: PIRç§»åŠ¨ä¾¦æµ‹
- `4`: ä½ç”µé‡
- `8`: ä½æ¸©æŠ¥è­¦
- `9`: é«˜æ¸©æŠ¥è­¦
- `10`: å£°éŸ³æŠ¥è­¦

## è‡ªåŠ¨åŒ–ç¤ºä¾‹

### 1. å¼€é—¨æ—¶å‘é€é€šçŸ¥

```yaml
automation:
  - alias: "é—¨é“ƒå¼€é—¨é€šçŸ¥"
    trigger:
      - platform: event
        event_type: dingding_smart_door_unlock
    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "é—¨é“ƒå¼€é—¨é€šçŸ¥"
          message: "æ£€æµ‹åˆ°å¼€é—¨äº‹ä»¶ï¼æ–¹å¼: {{ trigger.event.data.method }}"
```

### 2. é—¨å†…å¼€é”æ—¶å‘é€é€šçŸ¥

```yaml
automation:
  - alias: "é—¨å†…å¼€é”æé†’"
    trigger:
      - platform: event
        event_type: dingding_smart_door_unlock
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.method == 'inside_lock' }}"
    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "é—¨å†…å¼€é”"
          message: "æœ‰äººåœ¨é—¨å†…å¼€é”äº†ï¼"
```

### 3. é—¨é“ƒå‘¼å«æ—¶æ’­æ”¾å£°éŸ³

```yaml
automation:
  - alias: "é—¨é“ƒå‘¼å«æé†’"
    trigger:
      - platform: event
        event_type: dingding_smart_door_call
    action:
      - service: media_player.play_media
        target:
          entity_id: media_player.speaker
        data:
          media_content_id: "doorbell_sound.mp3"
          media_content_type: music
```

### 4. è®¾å¤‡ç¦»çº¿æ—¶æŠ¥è­¦

```yaml
automation:
  - alias: "é—¨é“ƒç¦»çº¿æŠ¥è­¦"
    trigger:
      - platform: event
        event_type: dingding_smart_door_offline
    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "é—¨é“ƒç¦»çº¿è­¦å‘Š"
          message: "é—¨é“ƒè®¾å¤‡ {{ trigger.event.data.name }} å·²ç¦»çº¿ï¼"
```

### 5. æŒ‡çº¹å¼€é”æ—¶è®°å½•æ—¥å¿—

```yaml
automation:
  - alias: "æŒ‡çº¹å¼€é”è®°å½•"
    trigger:
      - platform: event
        event_type: dingding_smart_door_unlock
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.method == 'fingerprint' }}"
    action:
      - service: logbook.log
        data:
          name: "é—¨é“ƒ"
          message: "æŒ‡çº¹å¼€é” - {{ trigger.event.data.name }}"
```

## æ•…éšœæ’é™¤

### ç™»å½•å¤±è´¥

**é”™è¯¯**: `auth_error`

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è´¦å·å¯ä»¥åœ¨é’‰é’‰æ™ºèƒ½Appä¸­æ­£å¸¸ç™»å½•
- æ£€æŸ¥æœåŠ¡å™¨åŒºåŸŸæ˜¯å¦é€‰æ‹©æ­£ç¡®

### æœªæ‰¾åˆ°è®¾å¤‡

**é”™è¯¯**: `no_devices`

**è§£å†³æ–¹æ³•**:
- ç¡®è®¤è´¦å·ä¸‹å·²ç»‘å®šè®¾å¤‡
- åœ¨é’‰é’‰æ™ºèƒ½Appä¸­æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨çº¿
- å°è¯•é‡æ–°ç™»å½•é’‰é’‰æ™ºèƒ½App

### æ¨é€è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: æ— æ³•æ¥æ”¶æ¨é€æ¶ˆæ¯

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤æ¨é€æœåŠ¡å™¨åœ°å€å’Œç«¯å£æ­£ç¡®
- æŸ¥çœ‹Home Assistantæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
- å°è¯•ä½¿ç”¨æµ‹è¯•è„šæœ¬å•ç‹¬æµ‹è¯•æ¨é€è¿æ¥

### SSLè¿æ¥é”™è¯¯

**ç—‡çŠ¶**: `SSL handshake failed`

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡®
- ç¡®è®¤é˜²ç«å¢™æ²¡æœ‰é˜»æ­¢SSLè¿æ¥
- å°è¯•é‡å¯Home Assistant
- æŸ¥çœ‹æ—¥å¿—ç¡®è®¤SSLè¯ä¹¦éªŒè¯å·²ç¦ç”¨

### é—¨é”çŠ¶æ€ä¸æ›´æ–°

**ç—‡çŠ¶**: é—¨é”çŠ¶æ€ä¸€ç›´æ˜¾ç¤ºå¼€é”

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥Home Assistantæ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
- ç¡®è®¤æ¨é€æœåŠ¡å·²è¿æ¥
- æŸ¥çœ‹äº‹ä»¶æ—¥å¿—ç¡®è®¤æ”¶åˆ°å¼€é—¨äº‹ä»¶
- é‡å¯Home Assistant

## æŠ€æœ¯ç»†èŠ‚

### æ¨é€åè®®

- **åè®®**: SSL/TLS over TCP
- **ç«¯å£**: 11001
- **æ¶ˆæ¯æ ¼å¼**: 8å­—èŠ‚æ¶ˆæ¯å¤´ + JSONæ•°æ®ä½“
- **å­—èŠ‚åº**: å°ç«¯åº
- **å¿ƒè·³è¶…æ—¶**: 130ç§’
- **é‡è¿æœºåˆ¶**: è‡ªåŠ¨é‡è¿ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°5æ¬¡
- **SSLè¯ä¹¦**: å·²ç¦ç”¨è¯ä¹¦éªŒè¯ï¼ˆå…¼å®¹æ€§ä¼˜åŒ–ï¼‰

### æ¶ˆæ¯å¤´æ ¼å¼

```
[0-3]   å‘½ä»¤ç±»å‹ (CMD) - 4å­—èŠ‚ï¼Œå°ç«¯åº
[4-7]   æ•°æ®é•¿åº¦ (LENGTH) - 4å­—èŠ‚ï¼Œå°ç«¯åº
```

### å‘½ä»¤ç±»å‹

| å‘½ä»¤ | å€¼ | è¯´æ˜ |
|------|-----|------|
| CMD_HEARTBEAT | 0 | å¿ƒè·³ |
| CMD_REGISTER | 1 | æ³¨å†Œ |
| CMD_TOKEN | 2 | Token |
| CMD_PUSH | 3 | æ¨é€ |

### å®ç°åŸç†

1. **è®¤è¯æµç¨‹**: é€šè¿‡æ¨¡æ‹Ÿé’‰é’‰æ™ºèƒ½Appçš„ç™»å½•è¯·æ±‚è·å–token
2. **è®¾å¤‡å‘ç°**: ä½¿ç”¨tokenè·å–ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡åˆ—è¡¨
3. **æ¨é€è¿æ¥**: å»ºç«‹SSL/TLSè¿æ¥åˆ°æ¨é€æœåŠ¡å™¨
4. **Tokenç»‘å®š**: å°†æ¨é€Tokenç»‘å®šåˆ°APIæœåŠ¡å™¨
5. **äº‹ä»¶å¤„ç†**: è§£ææ¨é€æ¶ˆæ¯å¹¶è½¬æ¢ä¸ºHome Assistantäº‹ä»¶
6. **çŠ¶æ€åŒæ­¥**: å®šæœŸåŒæ­¥è®¾å¤‡çŠ¶æ€
7. **æŒä¹…åŒ–å­˜å‚¨**: Tokenå’Œé…ç½®ä¿¡æ¯æŒä¹…åŒ–å­˜å‚¨

## å¼€å‘

### é¡¹ç›®ç»“æ„

```
homeassistant/
â”œâ”€â”€ custom_components/
â”‚   â””â”€â”€ dingding_smart/
â”‚       â”œâ”€â”€ __init__.py          # ä¸»é›†æˆæ–‡ä»¶
â”‚       â”œâ”€â”€ config_flow.py       # é…ç½®æµç¨‹
â”‚       â”œâ”€â”€ manifest.json        # é›†æˆæ¸…å•
â”‚       â”œâ”€â”€ sensor.py            # ä¼ æ„Ÿå™¨å®ä½“
â”‚       â”œâ”€â”€ binary_sensor.py     # äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨å®ä½“
â”‚       â””â”€â”€ strings.json         # æœ¬åœ°åŒ–å­—ç¬¦ä¸²
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â””â”€â”€ dingding_smart.zip         # å‘å¸ƒåŒ…
```

### å¼€å‘ç¯å¢ƒè®¾ç½®

1. å…‹éš†é¡¹ç›®åˆ°æœ¬åœ°
2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. ä¿®æ”¹ä»£ç åæµ‹è¯•
4. æäº¤Pull Request

### è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ç‰ˆæœ¬å†å²

### v1.0.12 (2026-02-25)
- âœ… ä¼˜åŒ–é—¨é”çŠ¶æ€è‡ªåŠ¨æ¢å¤æ—¶é—´ä¸º5ç§’
- âœ… æ·»åŠ ä¸­æ–‡æ–¹æ³•æ˜¾ç¤º

### v1.0.11 (2026-02-25)
- âœ… è°ƒæ•´é—¨é”çŠ¶æ€æ¢å¤æ—¶é—´ä¸º5ç§’

### v1.0.10 (2026-02-25)
- âœ… ä¿®å¤æ¨é€æœåŠ¡å’Œçº¿ç¨‹å®‰å…¨é—®é¢˜
- âœ… æ–°å¢é—¨é”çŠ¶æ€ä¼ æ„Ÿå™¨
- âœ… å®Œå…¨ç¦ç”¨SSLè¯ä¹¦éªŒè¯

### v1.0.9 (2026-02-24)
- âœ… TokenæŒä¹…åŒ–å­˜å‚¨
- âœ… ä¼˜åŒ–APIè¯·æ±‚å¤„ç†

## è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

## è‡´è°¢

- æ„Ÿè°¢é’‰é’‰æ™ºèƒ½é—¨é“ƒè®¾å¤‡çš„æ”¯æŒ
- åŸºäºé€†å‘çš„Pythonæ¨é€å®ç°
- Home Assistantç¤¾åŒºçš„æ”¯æŒ

